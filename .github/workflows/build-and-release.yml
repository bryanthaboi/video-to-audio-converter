name: Build and Release

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install NSIS
      run: |
        $nsisUrl = "https://sourceforge.net/projects/nsis/files/NSIS%203/3.09/nsis-3.09.zip/download"
        $nsisZip = "$env:TEMP\nsis.zip"
        
        Write-Host "Downloading NSIS..."
        Invoke-WebRequest -Uri $nsisUrl -OutFile $nsisZip -UseBasicParsing
        
        Write-Host "Extracting NSIS..."
        Expand-Archive -Path $nsisZip -DestinationPath "C:\" -Force
        if (Test-Path "C:\nsis-3.09") {
          Rename-Item -Path "C:\nsis-3.09" -NewName "nsis" -Force
        }
        
        $env:PATH = "C:\nsis;$env:PATH"
        echo "C:\nsis" | Out-File -FilePath $env:GITHUB_PATH -Append
        Write-Host "NSIS installed successfully"
        
    - name: Build installer
      working-directory: ./installer
      run: |
        Write-Host "Building installer..."
        C:\nsis\makensis.exe convert-audio.nsi
        
        if (Test-Path "VideoToAudioConverter-Installer.exe") {
          $file = Get-Item "VideoToAudioConverter-Installer.exe"
          Write-Host "‚úì Installer built successfully!"
          Write-Host "  File: $($file.Name)"
          Write-Host "  Size: $([math]::Round($file.Length / 1MB, 2)) MB"
        } else {
          Write-Error "‚úó Installer was not created!"
          exit 1
        }
        
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: installer-${{ github.sha }}
        path: installer/VideoToAudioConverter-Installer.exe
        retention-days: 30
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: installer/VideoToAudioConverter-Installer.exe
        name: Release ${{ github.ref_name }}
        body: |
          # Video to Audio Converter ${{ github.ref_name }}
          
          ## üì¶ Installation
          
          1. Download `VideoToAudioConverter-Installer.exe` below
          2. Run the installer
          3. Right-click any video file and select **Convert to MP3** or **Convert to WAV**
          
          ## ‚ú® Features
          
          - ‚úÖ Automatically detects and installs ffmpeg if needed
          - ‚úÖ Adds context menu options for video files
          - ‚úÖ Supports multiple video formats (MP4, AVI, MKV, MOV, WMV, FLV, WEBM, M4V, 3GP, OGV)
          - ‚úÖ Clean uninstaller
          - ‚úÖ Per-user installation (no admin rights required)
          
          ## üéØ Usage
          
          After installation, simply right-click on any video file and choose:
          - **Convert to MP3** - Creates a 256k MP3 file
          - **Convert to WAV** - Creates an uncompressed WAV file (PCM 16-bit, 44.1kHz)
          
          The converted file will be created in the same directory as the source file.
          
          ## üìù Technical Details
          
          - Built with NSIS (Nullsoft Scriptable Install System)
          - Uses PowerShell for conversion scripts
          - ffmpeg source: https://www.gyan.dev/ffmpeg/builds/
        draft: false
        prerelease: ${{ contains(github.ref_name, '-') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
